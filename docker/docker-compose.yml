version: '2'

services:
  weba_postgres:
      image: postgres:9.6
      container_name: weba_postgres
      hostname: weba_postgres
      ports:
        - "5432:5432"
      environment:
        POSTGRES_PASSWORD: "mysecretpassword"
        POSTGRES_DB: "weba"
      volumes:
        - ./postgres/data:/var/lib/postgresql/data
      networks:
        weba:
          ipv4_address: 100.0.0.10

  weba_zookeeper:
      image: wurstmeister/zookeeper:3.4.6
      container_name: weba_zookeeper
      ports:
        - "2181:2181"
        - "2888:2888"
        - "3888:3888"
#      volumes:
#        - ./zookeeper/data:/opt/zookeeper-3.4.6/data
      networks:
        weba:
          ipv4_address: 100.0.0.11

  weba_kafka:
      image: wurstmeister/kafka:0.9.0.1
      container_name: weba_kafka
      ports:
        - "9092:9092"
        - "9999:9999"
      links:
        - weba_zookeeper
      environment:
        KAFKA_ADVERTISED_HOST_NAME: 100.0.0.1
        KAFKA_CREATE_TOPICS: "weba_events:2:1"
        KAFKA_ZOOKEEPER_CONNECT: "weba_zookeeper:2181"
        KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
        KAFKA_DELETE_TOPIC_ENABLE: "true"
        KAFKA_LOG_RETENTION_HOURS: 1
        KAFKA_MESSAGE_MAX_BYTES: 50000000
        KAFKA_REPLICA_FETCH_MAX_BYTES: 100000000
        KAFKA_FETCH_MESSAGE_MAX_BYTES: 100000000
        KAFKA_NUM_PARTITIONS: 2
        JMX_PORT: 9999
        #KAFKA_HEAP_OPTS: "-Xmx2G -Xms2G"
        #KAFKA_JVM_PERFORMANCE_OPTS: "-XX:MaxPermSize=48M -verbose:gc -Xloggc:/var/log/kafka/gc.log -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintTenuringDistribution -XX:+PrintGCApplicationStoppedTime -XX:+PrintTLAB -XX:+DisableExplicitGC -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=10 -XX:GCLogFileSize=100M -XX:+UseCompressedOops -XX:+AlwaysPreTouch -XX:+UseG1GC -XX:MaxGCPauseMillis=20 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/var/log/kafka/heapDump.log"
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
      networks:
        weba:
          ipv4_address: 100.0.0.12

  weba_kafka_manager:
      image: sheepkiller/kafka-manager:1.3.1.6
      container_name: weba_kafka_manager
      hostname: weba_kafka_manager
      links:
        - weba_zookeeper
        - weba_kafka
      ports:
        - "9000:9000"
      environment:
        ZK_HOSTS: "weba_zookeeper:2181"
        KM_VERSION: "1.3.1.6"
        KM_REVISION: "6cf43e383377a6b37df4faa04d9aff515a265b30"
        KM_USERNAME: weba
        KM_PASSWORD: v2_5Ma?(+G[t!@;7
      networks:
        weba:
          ipv4_address: 100.0.0.13

  weba_entrypoint:
      container_name: weba_entrypoint
      build: entrypoint
      hostname: weba_entrypoint
      links:
         - weba_kafka
      ports:
         - 80:80
      environment:
        FLUME_CONF_FILE: /opt/flume/conf/flume.conf
        FLUME_AGENT_NAME: a1
        FLUME_PLUGINS_DIRECTORY: /opt/flume/plugins.d/
        FLUME_JAVA_OPTIONS: "-Xms1024m -Xmx2048m -Xss256k -XX:MaxDirectMemorySize=256m -XX:+UseParNewGC -XX:+UseConcMarkSweepGC"
      networks:
        weba:
          ipv4_address: 100.0.0.14

  weba_elasticsearch:
      image: elasticsearch:2.2.1
      container_name: weba_elasticsearch
      hostname: weba_elasticsearch
      environment:
        ES_HEAP_SIZE: "1g"
        ES_HEAP_NEWSIZE: "1g"
        ES_MIN_MEM: "512m"
        ES_MAX_MEM: "4g"
      ports:
        - 9200:9200
        - 9300:9300
      volumes:
        - ./elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
        - ./elasticsearch/config/logging.yml:/usr/share/elasticsearch/config/logging.yml
        - ./elasticsearch/data:/usr/share/elasticsearch/data
        - ./elasticsearch/log:/usr/share/elasticsearch/log
      networks:
        weba:
          ipv4_address: 100.0.0.15

  weba_kibana:
      image: kibana:4.4.1
      container_name: weba_kibana
      hostname: weba_kibana
      ports:
        - 5601:5601
      links:
        - weba_elasticsearch
      networks:
        weba:
          ipv4_address: 100.0.0.16

  weba_flink_jobmanager:
      build: flink
      container_name: weba_flink_jobmanager
      hostname: weba_flink_jobmanager
      ports:
        - 48080:8080
        - 6123:6123
      expose:
        - 22
      command: /usr/local/flink/bin/config-flink.sh jobmanager
      links:
        - weba_kafka
        - weba_elasticsearch
        - weba_zookeeper
      networks:
        weba:
          ipv4_address: 100.0.0.17

  weba_flink_worker:
      build: flink
      container_name: weba_flink_worker
      hostname: weba_flink_worker
      expose:
        - 6121
        - 6122
      ports:
        - 6121:6121
        - 6122:6122
      links:
        - weba_flink_jobmanager
        - weba_kafka
        - weba_elasticsearch
        - weba_zookeeper
      command: /usr/local/flink/bin/config-flink.sh taskmanager
      networks:
        weba:
          ipv4_address: 100.0.0.18

  weba_locust:
      container_name: weba_locust
      build: locust
      hostname: weba_locust
      links:
        - weba_entrypoint
      ports:
        - 8089:8089
      environment:
        TARGET_URL: "http://100.0.0.1/"
      networks:
        weba:
          ipv4_address: 100.0.0.19

networks:
  weba:
    driver: bridge
    ipam:
      driver: default
      config:
      - subnet: 100.0.0.0/24
        gateway: 100.0.0.1